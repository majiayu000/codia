# 实现计划文档 (Implementation Plan)

> **项目**: AI Virtual Companion (Codia)
>
> **作者**: Engineering Team
>
> **状态**: Draft → Review → Approved
>
> **创建日期**: 2026-01-04
>
> **最后更新**: 2026-01-04
>
> **审阅者**: @tech-lead, @product-team

---

## 变更记录

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-04 | Engineering Team | 初始版本 |

---

## 目录

1. [项目概述](#1-项目概述)
2. [开发阶段规划](#2-开发阶段规划)
3. [里程碑定义](#3-里程碑定义)
4. [详细任务分解](#4-详细任务分解)
5. [技术实现顺序](#5-技术实现顺序)
6. [依赖关系](#6-依赖关系)
7. [风险管理](#7-风险管理)
8. [资源需求](#8-资源需求)
9. [质量门禁](#9-质量门禁)
10. [交付检查清单](#10-交付检查清单)

---

## 1. 项目概述

### 1.1 项目目标

构建一个 Web 端 3D AI 虚拟伴侣应用，实现以下核心功能：
- VRM 3D 角色渲染与表情系统
- 多 LLM 后端支持的 AI 对话
- TTS/ASR 语音交互
- 实时口型同步
- 本地优先的数据存储

### 1.2 成功标准

| 标准 | 目标 | 衡量方式 |
|------|------|----------|
| 功能完整性 | 100% PRD 功能实现 | 功能验收测试 |
| 代码质量 | 测试覆盖率 ≥80% | Coverage 报告 |
| 性能指标 | LCP <3s, FPS ≥30 | Lighthouse + 性能测试 |
| 可访问性 | WCAG 2.2 AA | axe-core 测试 |

### 1.3 项目范围

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           项目范围                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Phase 1: MVP (8 周)                                                    │
│  ├── 3D 角色渲染 (VRM 加载、表情、口型)                                 │
│  ├── AI 对话 (OpenAI/Claude 集成、流式响应)                            │
│  ├── 语音交互 (TTS Kokoro、ASR Whisper)                                │
│  ├── 基础 UI (对话界面、设置面板)                                      │
│  └── 本地存储 (IndexedDB 持久化)                                       │
│                                                                         │
│  Phase 2: 体验增强 (4 周)                                               │
│  ├── 多角色支持                                                        │
│  ├── 角色自定义 (VRM 上传、人设编辑)                                   │
│  ├── 对话历史管理                                                      │
│  ├── 更多 TTS/LLM 后端                                                 │
│  └── 移动端优化                                                        │
│                                                                         │
│  Phase 3: 高级功能 (4 周) - 未来                                        │
│  ├── 表情捕捉                                                          │
│  ├── 多模态输入 (图片)                                                 │
│  ├── 场景/背景系统                                                     │
│  └── 社区分享                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 开发阶段规划

### 2.1 整体时间线

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Project Timeline                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Week 1-2: 项目基础设施                                                 │
│  ══════════════════════════════════════                                │
│  │ 项目初始化 │ 基础组件 │ CI/CD │                                     │
│                                                                         │
│  Week 3-4: 3D 渲染核心                                                  │
│            ══════════════════════════════════════                      │
│            │ VRM 加载 │ 表情系统 │ 口型同步 │                          │
│                                                                         │
│  Week 5-6: AI 对话系统                                                  │
│                        ══════════════════════════════════════          │
│                        │ LLM 集成 │ 流式响应 │ 对话管理 │              │
│                                                                         │
│  Week 7-8: 语音系统 + 集成                                              │
│                                    ══════════════════════════════════  │
│                                    │ TTS │ ASR │ 系统集成 │ 测试 │    │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  Week 1    Week 2    Week 3    Week 4    Week 5    Week 6    Week 7    Week 8 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 各阶段目标

| 阶段 | 时间 | 目标 | 交付物 |
|------|------|------|--------|
| **Sprint 1** | Week 1-2 | 项目基础设施 | 可运行的项目骨架 |
| **Sprint 2** | Week 3-4 | 3D 渲染核心 | VRM 角色可交互显示 |
| **Sprint 3** | Week 5-6 | AI 对话系统 | 完整对话功能 |
| **Sprint 4** | Week 7-8 | 语音 + 集成 | MVP 可发布版本 |

---

## 3. 里程碑定义

### 3.1 里程碑概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Milestones                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  M1: 项目骨架完成 (Week 2 末)                                           │
│  ─────────────────────────────                                          │
│  ✓ Next.js 项目初始化完成                                               │
│  ✓ 基础组件库搭建 (Button, Input, etc.)                                 │
│  ✓ 设计系统 Tailwind 配置                                               │
│  ✓ 测试框架配置 (Vitest + Playwright)                                   │
│  ✓ CI/CD 流水线运行                                                     │
│  ✓ 基础页面布局完成                                                     │
│                                                                         │
│  M2: 3D 角色渲染完成 (Week 4 末)                                        │
│  ─────────────────────────────                                          │
│  ✓ VRM 模型加载与显示                                                   │
│  ✓ 表情系统可控切换                                                     │
│  ✓ 口型同步动画工作                                                     │
│  ✓ 摄像机控制 (旋转/缩放)                                               │
│  ✓ 待机动画播放                                                         │
│  ✓ 性能优化 ≥30 FPS                                                    │
│                                                                         │
│  M3: AI 对话完成 (Week 6 末)                                            │
│  ─────────────────────────────                                          │
│  ✓ OpenAI API 集成                                                      │
│  ✓ Claude API 集成                                                      │
│  ✓ 流式响应显示                                                         │
│  ✓ 对话历史管理                                                         │
│  ✓ 角色人设系统                                                         │
│  ✓ 本地存储持久化                                                       │
│                                                                         │
│  M4: MVP 发布 (Week 8 末)                                               │
│  ─────────────────────────────                                          │
│  ✓ TTS 语音合成 (Kokoro)                                                │
│  ✓ ASR 语音识别 (Whisper)                                               │
│  ✓ 语音与口型同步                                                       │
│  ✓ 完整用户流程                                                         │
│  ✓ 测试覆盖率 ≥80%                                                      │
│  ✓ 性能达标                                                             │
│  ✓ 部署上线                                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 里程碑验收标准

#### M1: 项目骨架完成

| 验收项 | 标准 | 验证方式 |
|--------|------|----------|
| 项目运行 | `npm run dev` 无错误启动 | 手动验证 |
| 组件库 | 10+ 基础组件可用 | Storybook 检查 |
| 测试框架 | 单元测试可运行 | `npm run test` |
| CI/CD | PR 自动运行测试 | GitHub Actions |
| 布局 | 主页面结构完成 | 视觉验收 |

#### M2: 3D 角色渲染完成

| 验收项 | 标准 | 验证方式 |
|--------|------|----------|
| VRM 加载 | 模型正确显示 | 视觉验收 |
| 表情系统 | 6 种表情可切换 | 功能测试 |
| 口型同步 | 音频同步口型 | 功能测试 |
| 帧率 | ≥30 FPS | Performance 测试 |
| 交互 | 拖拽旋转/缩放 | 功能测试 |

#### M3: AI 对话完成

| 验收项 | 标准 | 验证方式 |
|--------|------|----------|
| OpenAI | 正确响应 | API 测试 |
| Claude | 正确响应 | API 测试 |
| 流式显示 | 打字机效果 | 视觉验收 |
| 历史保存 | 刷新后恢复 | 功能测试 |
| 人设生效 | 角色按人设回复 | 人工验收 |

#### M4: MVP 发布

| 验收项 | 标准 | 验证方式 |
|--------|------|----------|
| TTS | 语音播放 | 功能测试 |
| ASR | 语音识别 | 功能测试 |
| 端到端 | 完整流程通过 | E2E 测试 |
| 覆盖率 | ≥80% | Coverage 报告 |
| 性能 | LCP <3s | Lighthouse |
| 部署 | 线上可访问 | 手动验证 |

---

## 4. 详细任务分解

### 4.1 Sprint 1: 项目基础设施 (Week 1-2)

#### Week 1: 项目初始化

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 1.1: 项目初始化                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1.1.1 创建 Next.js 项目                                                │
│        ├── npx create-next-app@latest                                   │
│        ├── TypeScript + App Router                                      │
│        ├── Tailwind CSS 配置                                            │
│        └── ESLint + Prettier 配置                                       │
│        预估: 2h                                                         │
│                                                                         │
│  1.1.2 设计系统配置                                                     │
│        ├── tailwind.config.ts 颜色/字体/间距                            │
│        ├── globals.css CSS 变量                                         │
│        ├── 暗色模式支持                                                 │
│        └── 响应式断点                                                   │
│        预估: 4h                                                         │
│                                                                         │
│  1.1.3 测试框架配置                                                     │
│        ├── Vitest 单元测试                                              │
│        ├── Testing Library 组件测试                                     │
│        ├── Playwright E2E 测试                                          │
│        └── Coverage 报告                                                │
│        预估: 4h                                                         │
│                                                                         │
│  1.1.4 CI/CD 配置                                                       │
│        ├── GitHub Actions workflow                                      │
│        ├── 自动测试 + 构建                                              │
│        ├── Vercel 部署                                                  │
│        └── 代码质量检查                                                 │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Week 2: 基础组件开发

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 1.2: 基础组件库                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1.2.1 核心 UI 组件                                                     │
│        ├── Button (primary/secondary/ghost/icon)                        │
│        ├── Input / Textarea                                             │
│        ├── Select / Dropdown                                            │
│        ├── Modal / Dialog                                               │
│        ├── Toast / Notification                                         │
│        └── Loading / Spinner                                            │
│        预估: 8h                                                         │
│                                                                         │
│  1.2.2 布局组件                                                         │
│        ├── Layout (Header + Main + Sidebar)                             │
│        ├── Card                                                         │
│        ├── Panel                                                        │
│        └── Divider                                                      │
│        预估: 4h                                                         │
│                                                                         │
│  1.2.3 对话组件                                                         │
│        ├── MessageBubble                                                │
│        ├── ChatInput                                                    │
│        ├── MessageList                                                  │
│        └── TypingIndicator                                              │
│        预估: 6h                                                         │
│                                                                         │
│  1.2.4 页面布局                                                         │
│        ├── 主页面结构                                                   │
│        ├── 3D Canvas 容器                                               │
│        ├── 侧边栏布局                                                   │
│        └── 响应式适配                                                   │
│        预估: 6h                                                         │
│                                                                         │
│  1.2.5 Storybook 文档                                                   │
│        ├── 组件文档                                                     │
│        ├── 使用示例                                                     │
│        └── 交互演示                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Sprint 2: 3D 渲染核心 (Week 3-4)

#### Week 3: VRM 加载与渲染

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 2.1: VRM 模型系统                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  2.1.1 Three.js 基础设置                                                │
│        ├── @react-three/fiber 集成                                      │
│        ├── Scene / Camera / Lights 配置                                 │
│        ├── OrbitControls 设置                                           │
│        └── 性能监控                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  2.1.2 VRM 加载器实现                                                   │
│        ├── @pixiv/three-vrm 集成                                        │
│        ├── VRM 模型加载                                                 │
│        ├── 加载进度反馈                                                 │
│        └── 错误处理                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  2.1.3 VRMService 类                                                    │
│        ├── 单例管理                                                     │
│        ├── 模型加载/卸载                                                │
│        ├── 状态管理                                                     │
│        └── 事件系统                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  2.1.4 角色展示组件                                                     │
│        ├── CharacterCanvas 组件                                         │
│        ├── 摄像机控制                                                   │
│        ├── 背景设置                                                     │
│        └── 加载状态 UI                                                  │
│        预估: 6h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Week 4: 表情与口型系统

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 2.2: 表情系统                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  2.2.1 ExpressionController 类                                          │
│        ├── VRM 表情映射                                                 │
│        ├── 表情切换逻辑                                                 │
│        ├── 平滑过渡动画                                                 │
│        └── 表情混合                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  2.2.2 情绪检测                                                         │
│        ├── 文本情绪分析                                                 │
│        ├── 情绪到表情映射                                               │
│        ├── 情绪强度计算                                                 │
│        └── 上下文理解                                                   │
│        预估: 4h                                                         │
│                                                                         │
│  2.2.3 待机动画                                                         │
│        ├── 眨眼动画                                                     │
│        ├── 呼吸动画                                                     │
│        ├── 随机小动作                                                   │
│        └── 弹簧物理                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Task 2.3: 口型同步系统                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  2.3.1 LipSyncController 类                                             │
│        ├── Viseme 定义                                                  │
│        ├── VRM BlendShape 映射                                          │
│        ├── 平滑过渡                                                     │
│        └── 时间同步                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  2.3.2 音频分析                                                         │
│        ├── Web Audio API 集成                                           │
│        ├── 音量检测                                                     │
│        ├── 频率分析 (可选)                                              │
│        └── 实时处理                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  2.3.3 性能优化                                                         │
│        ├── 渲染优化                                                     │
│        ├── 模型 LOD                                                     │
│        ├── 纹理压缩                                                     │
│        └── 帧率监控                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Sprint 3: AI 对话系统 (Week 5-6)

#### Week 5: LLM 集成

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 3.1: LLM 服务集成                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  3.1.1 ChatService 核心                                                 │
│        ├── 消息模型定义                                                 │
│        ├── 历史管理                                                     │
│        ├── 提供者抽象                                                   │
│        └── 事件发射                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  3.1.2 OpenAI 提供者                                                    │
│        ├── API 客户端                                                   │
│        ├── 流式响应处理                                                 │
│        ├── 错误处理                                                     │
│        └── 重试逻辑                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  3.1.3 Claude 提供者                                                    │
│        ├── API 客户端                                                   │
│        ├── 流式响应                                                     │
│        ├── 消息格式转换                                                 │
│        └── 错误处理                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  3.1.4 Ollama 提供者 (可选)                                             │
│        ├── 本地 API 连接                                                │
│        ├── 模型选择                                                     │
│        └── 流式响应                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Week 6: 对话功能完善

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 3.2: 对话功能                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  3.2.1 对话 UI 完善                                                     │
│        ├── 消息列表优化                                                 │
│        ├── 流式显示效果                                                 │
│        ├── 滚动行为                                                     │
│        └── 输入状态管理                                                 │
│        预估: 6h                                                         │
│                                                                         │
│  3.2.2 角色人设系统                                                     │
│        ├── 人设模板                                                     │
│        ├── 自定义人设                                                   │
│        ├── 人设注入                                                     │
│        └── 人设持久化                                                   │
│        预估: 4h                                                         │
│                                                                         │
│  3.2.3 状态管理                                                         │
│        ├── Zustand Store 实现                                           │
│        ├── 对话状态                                                     │
│        ├── 设置状态                                                     │
│        └── 角色状态                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  3.2.4 本地持久化                                                       │
│        ├── IndexedDB 设置                                               │
│        ├── 对话历史存储                                                 │
│        ├── 设置存储                                                     │
│        └── 数据迁移                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  3.2.5 API Key 管理                                                     │
│        ├── 安全存储 (加密)                                              │
│        ├── 验证功能                                                     │
│        ├── 多 Key 管理                                                  │
│        └── 配置 UI                                                      │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 Sprint 4: 语音系统与集成 (Week 7-8)

#### Week 7: 语音功能

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 4.1: TTS 语音合成                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  4.1.1 TTSService 核心                                                  │
│        ├── 提供者抽象                                                   │
│        ├── 音频播放管理                                                 │
│        ├── 队列处理                                                     │
│        └── 事件发射                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  4.1.2 Kokoro TTS (本地)                                                │
│        ├── WASM 加载                                                    │
│        ├── 模型初始化                                                   │
│        ├── 合成调用                                                     │
│        └── 性能优化                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  4.1.3 ElevenLabs TTS (云端)                                            │
│        ├── API 集成                                                     │
│        ├── 音色选择                                                     │
│        ├── 流式播放                                                     │
│        └── 回退处理                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  4.1.4 TTS + 口型联动                                                   │
│        ├── Viseme 生成                                                  │
│        ├── 时间同步                                                     │
│        └── 实时更新                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Task 4.2: ASR 语音识别                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  4.2.1 ASRService 核心                                                  │
│        ├── 麦克风访问                                                   │
│        ├── 录音管理                                                     │
│        ├── VAD 检测                                                     │
│        └── 状态机                                                       │
│        预估: 4h                                                         │
│                                                                         │
│  4.2.2 Whisper 浏览器端                                                 │
│        ├── WASM/WebGPU 加载                                             │
│        ├── 模型初始化                                                   │
│        ├── 转录调用                                                     │
│        └── 多语言支持                                                   │
│        预估: 6h                                                         │
│                                                                         │
│  4.2.3 语音 UI                                                          │
│        ├── 录音按钮                                                     │
│        ├── 波形可视化                                                   │
│        ├── 状态指示                                                     │
│        └── 结果确认                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Week 8: 集成与发布

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Task 4.3: 系统集成                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  4.3.1 完整流程集成                                                     │
│        ├── 用户输入 → AI 响应 → TTS → 口型                              │
│        ├── 语音输入 → ASR → AI 响应                                     │
│        ├── 表情同步                                                     │
│        └── 错误恢复                                                     │
│        预估: 6h                                                         │
│                                                                         │
│  4.3.2 设置面板完善                                                     │
│        ├── 通用设置                                                     │
│        ├── 角色设置                                                     │
│        ├── 语音设置                                                     │
│        ├── LLM 配置                                                     │
│        └── 隐私设置                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  4.3.3 引导流程                                                         │
│        ├── 首次使用引导                                                 │
│        ├── 快速设置                                                     │
│        └── 帮助提示                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Task 4.4: 测试与发布                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  4.4.1 测试补充                                                         │
│        ├── 单元测试补充                                                 │
│        ├── 集成测试                                                     │
│        ├── E2E 测试                                                     │
│        └── 性能测试                                                     │
│        预估: 8h                                                         │
│                                                                         │
│  4.4.2 Bug 修复                                                         │
│        ├── 测试发现问题                                                 │
│        ├── 边界情况处理                                                 │
│        └── 兼容性问题                                                   │
│        预估: 6h                                                         │
│                                                                         │
│  4.4.3 性能优化                                                         │
│        ├── Bundle 优化                                                  │
│        ├── 加载优化                                                     │
│        ├── 渲染优化                                                     │
│        └── 内存优化                                                     │
│        预估: 4h                                                         │
│                                                                         │
│  4.4.4 部署上线                                                         │
│        ├── 生产环境配置                                                 │
│        ├── CDN 配置                                                     │
│        ├── 域名/SSL                                                     │
│        └── 监控设置                                                     │
│        预估: 4h                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 技术实现顺序

### 5.1 模块实现顺序

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Implementation Order                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段 1: 基础设施 (必须先完成)                                          │
│  ════════════════════════════════════════════════════════════════════  │
│                                                                         │
│  1. 项目初始化 ─────────────────────────────────┐                       │
│     ↓                                          │                       │
│  2. 设计系统配置 ───────────────────────────────┤                       │
│     ↓                                          │                       │
│  3. 测试框架 ───────────────────────────────────┤                       │
│     ↓                                          │                       │
│  4. CI/CD ──────────────────────────────────────┤                       │
│     ↓                                          ↓                       │
│  5. 基础 UI 组件 ─────────────────────→ 6. 页面布局                    │
│                                                                         │
│  阶段 2: 核心功能 (可部分并行)                                          │
│  ════════════════════════════════════════════════════════════════════  │
│                                                                         │
│  7. VRMService ─────┐                                                   │
│     ↓               │                                                   │
│  8. ExpressionController ───→ 9. LipSyncController                     │
│                               ↓                                        │
│  10. ChatService ─────────────→ 11. 对话 UI                            │
│      ↓                         ↓                                        │
│  12. Zustand Store ────────────→ 13. IndexedDB                         │
│                                                                         │
│  阶段 3: 语音集成 (依赖阶段 2)                                          │
│  ════════════════════════════════════════════════════════════════════  │
│                                                                         │
│  14. TTSService ─────────────┐                                          │
│      ↓                       │                                          │
│  15. TTS-LipSync 联动 ───────┤                                          │
│                              │                                          │
│  16. ASRService ─────────────┼───→ 17. 完整流程集成                    │
│                              │         ↓                               │
│                              └───→ 18. 设置 UI 完善                    │
│                                        ↓                               │
│                                    19. 引导流程                        │
│                                        ↓                               │
│                                    20. 测试与发布                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 文件创建顺序

```typescript
// Phase 1: 基础设施
src/
├── app/
│   ├── layout.tsx           // 1. 根布局
│   ├── page.tsx             // 2. 主页面
│   └── globals.css          // 3. 全局样式
├── components/
│   ├── ui/
│   │   ├── Button.tsx       // 4. 按钮
│   │   ├── Input.tsx        // 5. 输入框
│   │   ├── Modal.tsx        // 6. 模态框
│   │   └── ...              // 7-10. 其他 UI
│   └── layout/
│       ├── Header.tsx       // 11. 头部
│       ├── Sidebar.tsx      // 12. 侧边栏
│       └── MainLayout.tsx   // 13. 主布局

// Phase 2: 核心功能
├── services/
│   ├── vrm-service.ts       // 14. VRM 服务
│   ├── expression-controller.ts // 15. 表情控制
│   ├── lip-sync-controller.ts   // 16. 口型同步
│   ├── chat-service.ts     // 17. 对话服务
│   └── providers/
│       ├── openai.ts       // 18. OpenAI
│       └── claude.ts       // 19. Claude
├── components/
│   ├── character/
│   │   ├── CharacterCanvas.tsx  // 20. 3D 画布
│   │   └── CharacterLoader.tsx  // 21. 加载器
│   └── chat/
│       ├── MessageBubble.tsx    // 22. 消息气泡
│       ├── ChatInput.tsx        // 23. 对话输入
│       └── MessageList.tsx      // 24. 消息列表
├── store/
│   └── app-store.ts        // 25. 状态管理
└── lib/
    └── indexeddb.ts        // 26. 本地存储

// Phase 3: 语音系统
├── services/
│   ├── tts-service.ts      // 27. TTS 服务
│   ├── asr-service.ts      // 28. ASR 服务
│   └── providers/
│       ├── kokoro.ts       // 29. Kokoro TTS
│       └── whisper.ts      // 30. Whisper ASR
├── components/
│   └── voice/
│       ├── VoiceButton.tsx  // 31. 语音按钮
│       └── Waveform.tsx     // 32. 波形显示
└── app/
    └── settings/
        └── page.tsx        // 33. 设置页面
```

---

## 6. 依赖关系

### 6.1 模块依赖图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Module Dependencies                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          ┌─────────────┐                                │
│                          │   App UI    │                                │
│                          └──────┬──────┘                                │
│                                 │                                       │
│           ┌─────────────────────┼─────────────────────┐                │
│           │                     │                     │                │
│           ▼                     ▼                     ▼                │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐       │
│  │  CharacterView  │   │    ChatView     │   │   SettingsView  │       │
│  └────────┬────────┘   └────────┬────────┘   └────────┬────────┘       │
│           │                     │                     │                │
│           ▼                     ▼                     ▼                │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐       │
│  │   VRMService    │   │   ChatService   │   │   AppStore      │       │
│  │                 │   │                 │   │   (Zustand)     │       │
│  │  ┌───────────┐  │   │  ┌───────────┐  │   │                 │       │
│  │  │Expression │  │   │  │ Providers │  │   │  ┌───────────┐  │       │
│  │  │Controller │  │   │  │OpenAI/etc │  │   │  │ IndexedDB │  │       │
│  │  └───────────┘  │   │  └───────────┘  │   │  └───────────┘  │       │
│  │  ┌───────────┐  │   └────────┬────────┘   └────────┬────────┘       │
│  │  │ LipSync   │  │            │                     │                │
│  │  │Controller │◀─┼────────────┼─────────────────────┘                │
│  │  └───────────┘  │            │                                      │
│  └────────┬────────┘            │                                      │
│           │                     │                                      │
│           │        ┌────────────┴────────────┐                         │
│           │        │                         │                         │
│           ▼        ▼                         ▼                         │
│  ┌─────────────────────┐         ┌─────────────────────┐               │
│  │     TTSService      │         │     ASRService      │               │
│  │                     │         │                     │               │
│  │  ┌─────────────┐    │         │  ┌─────────────┐    │               │
│  │  │ Kokoro/     │    │         │  │ Whisper     │    │               │
│  │  │ ElevenLabs  │    │         │  │             │    │               │
│  │  └─────────────┘    │         │  └─────────────┘    │               │
│  └─────────────────────┘         └─────────────────────┘               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 外部依赖清单

```json
{
  "dependencies": {
    // Framework
    "next": "^14.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",

    // 3D Rendering
    "three": "^0.160.0",
    "@react-three/fiber": "^8.15.0",
    "@react-three/drei": "^9.90.0",
    "@pixiv/three-vrm": "^2.1.0",

    // State Management
    "zustand": "^4.4.0",
    "idb": "^8.0.0",

    // AI/LLM
    "openai": "^4.20.0",
    "@anthropic-ai/sdk": "^0.10.0",

    // Voice
    "@anthropic-ai/sdk": "^0.10.0",

    // UI
    "tailwindcss": "^3.4.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.0.0",
    "lucide-react": "^0.300.0",
    "framer-motion": "^10.16.0"
  },
  "devDependencies": {
    // TypeScript
    "typescript": "^5.3.0",
    "@types/react": "^18.2.0",
    "@types/node": "^20.10.0",

    // Testing
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.0.0",
    "@playwright/test": "^1.40.0",

    // Code Quality
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

### 6.3 关键路径

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Critical Path                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  项目初始化 → 基础组件 → VRMService → ChatService → TTSService         │
│      ↓           ↓           ↓            ↓            ↓               │
│    2天         4天         4天          4天          4天               │
│                                                                         │
│  总关键路径: 18 天 (不含测试和集成)                                      │
│                                                                         │
│  并行可执行:                                                            │
│  - 表情系统可与 ChatService 并行                                        │
│  - ASR 可与 TTS 并行                                                    │
│  - UI 优化可与核心功能并行                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 风险管理

### 7.1 风险矩阵

| 风险 | 可能性 | 影响 | 等级 | 缓解措施 |
|------|--------|------|------|----------|
| VRM 加载性能差 | 中 | 高 | 高 | 模型优化、延迟加载、降级方案 |
| 浏览器 API 兼容性 | 中 | 高 | 高 | 特性检测、Polyfill、降级 |
| TTS 延迟过高 | 中 | 中 | 中 | 本地 TTS、预加载、流式处理 |
| LLM API 不稳定 | 低 | 高 | 中 | 多提供者回退、本地缓存 |
| 口型同步不准确 | 高 | 低 | 中 | 基于音量的简化方案 |
| 内存泄漏 | 中 | 中 | 中 | 严格的资源管理、监控 |
| 移动端性能 | 高 | 中 | 中 | 渐进增强、降级渲染 |

### 7.2 风险应对计划

```
┌─────────────────────────────────────────────────────────────────────────┐
│  风险: VRM 加载性能差                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  触发条件: 模型加载 > 5s 或渲染 < 20 FPS                                │
│                                                                         │
│  应对措施:                                                              │
│  1. 模型压缩 (Draco, KTX2 纹理)                                         │
│  2. LOD 系统 (多级细节)                                                 │
│  3. 延迟加载 (渐进式)                                                   │
│  4. Web Worker 加载                                                     │
│  5. 降级到 2D 头像                                                      │
│                                                                         │
│  负责人: 3D 工程师                                                      │
│  检查点: Week 4 末                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  风险: 浏览器 API 兼容性                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  触发条件: Safari/Firefox 核心功能失败                                  │
│                                                                         │
│  关注点:                                                                │
│  - WebGPU (Safari 不完全支持)                                           │
│  - AudioWorklet (部分浏览器)                                            │
│  - IndexedDB (隐私模式)                                                 │
│                                                                         │
│  应对措施:                                                              │
│  1. 特性检测 + 降级方案                                                 │
│  2. WebGL 作为 WebGPU 回退                                              │
│  3. ScriptProcessorNode 作为 AudioWorklet 回退                          │
│  4. localStorage 作为 IndexedDB 回退                                    │
│                                                                         │
│  负责人: 前端工程师                                                     │
│  检查点: 每个 Sprint 末                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.3 应急预案

| 场景 | 预案 |
|------|------|
| 3D 渲染完全失败 | 回退到 2D 静态/动画头像 |
| LLM API 全部不可用 | 显示友好错误，建议配置本地 Ollama |
| TTS 不可用 | 仅显示文字，禁用语音功能 |
| ASR 不可用 | 仅支持文字输入 |
| 本地存储失败 | 会话内存储，警告用户数据不会保存 |

---

## 8. 资源需求

### 8.1 团队配置

| 角色 | 人数 | 职责 |
|------|------|------|
| **Tech Lead** | 1 | 架构设计、技术决策、代码审查 |
| **前端工程师** | 2 | UI 开发、状态管理、集成 |
| **3D 工程师** | 1 | Three.js、VRM、动画系统 |
| **QA 工程师** | 1 | 测试策略、自动化测试、质量保证 |
| **设计师** | 1 (兼职) | UI 设计、交互设计、设计系统 |

### 8.2 工时估算

| Sprint | 工作量 (人天) | 分配 |
|--------|--------------|------|
| Sprint 1 | 40 | 项目设置 + 组件开发 |
| Sprint 2 | 50 | 3D 系统 (复杂度高) |
| Sprint 3 | 45 | AI 对话系统 |
| Sprint 4 | 55 | 语音 + 集成测试 |
| **总计** | **190** | 约 9.5 人周 |

### 8.3 技术资源

| 资源 | 用途 | 费用 |
|------|------|------|
| GitHub Team | 代码托管 + Actions | $4/user/month |
| Vercel Pro | 部署托管 | $20/month |
| OpenAI API | 开发测试 | ~$50/month |
| ElevenLabs | TTS 测试 | ~$5/month |
| BrowserStack | 跨浏览器测试 | $39/month |

---

## 9. 质量门禁

### 9.1 代码质量门禁

```yaml
# 每次 PR 必须通过
code_quality:
  - lint: eslint 无错误
  - typecheck: tsc 无错误
  - format: prettier 格式化
  - test: 单元测试通过
  - coverage: 新代码覆盖率 ≥80%
  - security: npm audit 无高危漏洞
  - bundle: 包体大小不超过预算
```

### 9.2 功能质量门禁

```yaml
# 每个 Sprint 结束必须满足
feature_quality:
  - acceptance: 所有验收标准通过
  - integration: 集成测试通过
  - performance: 性能指标达标
  - accessibility: axe-core 无严重问题
  - browser: Chrome/Firefox/Safari 测试通过
```

### 9.3 发布质量门禁

```yaml
# MVP 发布前必须满足
release_quality:
  - e2e: 所有 E2E 测试通过
  - coverage: 总体覆盖率 ≥80%
  - lighthouse: Performance ≥70, Accessibility ≥90
  - security: 无已知安全漏洞
  - documentation: README + API 文档完整
  - monitoring: 错误监控 + 分析已配置
```

---

## 10. 交付检查清单

### 10.1 Sprint 1 交付清单

```markdown
## Sprint 1 Checklist (Week 1-2)

### 项目初始化
- [ ] Next.js 项目创建并运行
- [ ] TypeScript 配置完成
- [ ] Tailwind CSS 配置完成
- [ ] ESLint + Prettier 配置
- [ ] 设计系统颜色/字体/间距定义

### 测试框架
- [ ] Vitest 配置并可运行
- [ ] Testing Library 配置
- [ ] Playwright 配置
- [ ] Coverage 报告可生成

### CI/CD
- [ ] GitHub Actions workflow
- [ ] PR 自动运行测试
- [ ] Vercel 部署配置
- [ ] 自动部署预览环境

### 基础组件
- [ ] Button 组件 (4 变体)
- [ ] Input / Textarea 组件
- [ ] Modal / Dialog 组件
- [ ] Toast 组件
- [ ] Loading / Spinner 组件

### 页面布局
- [ ] 主页面结构
- [ ] Header 组件
- [ ] Sidebar 组件
- [ ] 3D Canvas 占位符
- [ ] 响应式布局

### 文档
- [ ] README 更新
- [ ] 组件 Storybook (可选)
```

### 10.2 Sprint 2 交付清单

```markdown
## Sprint 2 Checklist (Week 3-4)

### VRM 系统
- [ ] Three.js 场景配置
- [ ] VRM 模型加载
- [ ] 加载进度显示
- [ ] 错误处理

### 表情系统
- [ ] ExpressionController 类
- [ ] 6 种基础表情切换
- [ ] 平滑过渡动画
- [ ] 情绪检测函数

### 口型同步
- [ ] LipSyncController 类
- [ ] Viseme 映射
- [ ] 音频同步
- [ ] 嘴型平滑过渡

### 待机动画
- [ ] 眨眼动画
- [ ] 呼吸动画
- [ ] 弹簧物理

### 角色交互
- [ ] CharacterCanvas 组件
- [ ] 摄像机控制
- [ ] 拖拽旋转
- [ ] 滚轮缩放

### 性能
- [ ] 帧率 ≥30 FPS
- [ ] 内存使用合理
- [ ] 无明显卡顿
```

### 10.3 Sprint 3 交付清单

```markdown
## Sprint 3 Checklist (Week 5-6)

### ChatService
- [ ] ChatService 类实现
- [ ] 消息模型定义
- [ ] 历史管理
- [ ] 事件发射

### LLM 提供者
- [ ] OpenAI 提供者
- [ ] Claude 提供者
- [ ] 流式响应处理
- [ ] 错误处理和重试

### 对话 UI
- [ ] MessageBubble 组件
- [ ] ChatInput 组件
- [ ] MessageList 组件
- [ ] 流式显示效果
- [ ] TypingIndicator

### 状态管理
- [ ] Zustand Store
- [ ] 对话状态
- [ ] 设置状态
- [ ] 角色状态

### 持久化
- [ ] IndexedDB 配置
- [ ] 对话历史存储
- [ ] 设置存储
- [ ] 数据恢复

### 角色人设
- [ ] 人设模板
- [ ] 自定义人设
- [ ] 人设注入到对话
```

### 10.4 Sprint 4 (MVP) 交付清单

```markdown
## Sprint 4 Checklist (Week 7-8)

### TTS 系统
- [ ] TTSService 类
- [ ] Kokoro TTS 集成
- [ ] ElevenLabs 集成 (可选)
- [ ] 音频播放管理
- [ ] TTS + 口型联动

### ASR 系统
- [ ] ASRService 类
- [ ] Whisper 浏览器端集成
- [ ] 麦克风录音
- [ ] VAD 检测
- [ ] 语音 UI

### 系统集成
- [ ] 完整对话流程
- [ ] 语音到文字到 AI 到语音
- [ ] 表情与对话同步
- [ ] 错误恢复机制

### 设置完善
- [ ] 通用设置页
- [ ] 角色设置页
- [ ] 语音设置页
- [ ] LLM 配置页
- [ ] 隐私设置页

### 引导流程
- [ ] 首次使用引导
- [ ] 快速设置向导
- [ ] 帮助提示

### 测试
- [ ] 单元测试覆盖率 ≥80%
- [ ] 集成测试通过
- [ ] E2E 测试通过
- [ ] 性能测试通过
- [ ] 可访问性测试通过
- [ ] 跨浏览器测试

### 部署
- [ ] 生产环境配置
- [ ] CDN 配置
- [ ] 域名 + SSL
- [ ] 错误监控
- [ ] 分析埋点

### 文档
- [ ] README 完整
- [ ] API 文档
- [ ] 部署文档
- [ ] 用户指南
```

---

## 附录

### A. 每日站会模板

```markdown
## Daily Standup - [日期]

### 昨天完成
- [ ] 任务 1
- [ ] 任务 2

### 今天计划
- [ ] 任务 1
- [ ] 任务 2

### 阻塞/问题
- 问题描述及影响
```

### B. Sprint 回顾模板

```markdown
## Sprint [N] Retrospective

### 完成情况
- 计划任务: X 个
- 完成任务: Y 个
- 完成率: Y/X = Z%

### 做得好的
1. ...
2. ...

### 需要改进的
1. ...
2. ...

### 行动项
1. [负责人] 行动描述
2. [负责人] 行动描述
```

### C. 技术决策记录模板

```markdown
## ADR-[编号]: [标题]

**状态**: Proposed / Accepted / Deprecated

**日期**: YYYY-MM-DD

**背景**:
描述问题背景和约束

**决策**:
我们选择 [方案]

**原因**:
1. 原因 1
2. 原因 2

**替代方案**:
- 方案 A: 优缺点
- 方案 B: 优缺点

**影响**:
- 正面影响
- 潜在风险
```

---

**文档结束**

*此文档将随项目进展持续更新。*
